{"summary":"<blockquote><p>慢速 SQL 的优化实践</p>\n</blockquote>\n<a id=\"more\"></a>\n<h2 id=\"Q1：执行时长-2-秒；解析行数-535569；返回行数-0\"><a href=\"#Q1：执行时长-2-秒；解析行数-535569；返回行数-0\" class=\"headerlink\" title=\"Q1：执行时长 2 秒；解析行数 535569；返回行数 0\"></a>Q1：执行时长 2 秒；解析行数 535569；返回行数 0</h2><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">SELECT</span> *</div><div class=\"line\"><span class=\"keyword\">FROM</span> <span class=\"string\">`pin_order`</span></div><div class=\"line\"><span class=\"keyword\">WHERE</span> <span class=\"string\">`status`</span> = <span class=\"number\">5</span></div><div class=\"line\">  <span class=\"keyword\">AND</span> <span class=\"string\">`pay_kind`</span> &lt;&gt; <span class=\"number\">2</span>;</div></pre></td></tr></table></figure>\n<h3 id=\"A1：联合索引\"><a href=\"#A1：联合索引\" class=\"headerlink\" title=\"A1：联合索引\"></a>A1：联合索引</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">INDEX</span> <span class=\"string\">`idx_status_pay_kind`</span></div><div class=\"line\">  <span class=\"keyword\">ON</span> pin_order ( <span class=\"string\">`status`</span> , <span class=\"string\">`pay_kind`</span> );</div></pre></td></tr></table></figure>\n<h2 id=\"Q2：执行时长-1-秒；解析行数-433707；返回行数-0\"><a href=\"#Q2：执行时长-1-秒；解析行数-433707；返回行数-0\" class=\"headerlink\" title=\"Q2：执行时长 1 秒；解析行数 433707；返回行数 0\"></a>Q2：执行时长 1 秒；解析行数 433707；返回行数 0</h2><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"string\">`o`</span>.<span class=\"string\">`order_id`</span>, <span class=\"string\">`w`</span>.<span class=\"string\">`title`</span>, <span class=\"string\">`u`</span>.<span class=\"string\">`tg_user_id`</span>, <span class=\"string\">`o`</span>.<span class=\"string\">`express_mobile`</span></div><div class=\"line\"><span class=\"keyword\">FROM</span> <span class=\"string\">`pin_group`</span> <span class=\"string\">`g`</span></div><div class=\"line\">       <span class=\"keyword\">INNER</span> <span class=\"keyword\">JOIN</span> <span class=\"string\">`pin_ware`</span> <span class=\"string\">`w`</span> <span class=\"keyword\">ON</span> <span class=\"string\">`w`</span>.<span class=\"string\">`ware_id`</span> = <span class=\"string\">`g`</span>.<span class=\"string\">`ware_id`</span></div><div class=\"line\">       <span class=\"keyword\">INNER</span> <span class=\"keyword\">JOIN</span> <span class=\"string\">`pin_order`</span> <span class=\"string\">`o`</span> <span class=\"keyword\">ON</span> <span class=\"string\">`o`</span>.<span class=\"string\">`group_id`</span> = <span class=\"string\">`g`</span>.<span class=\"string\">`group_id`</span></div><div class=\"line\">       <span class=\"keyword\">INNER</span> <span class=\"keyword\">JOIN</span> <span class=\"string\">`pin_user`</span> <span class=\"string\">`u`</span> <span class=\"keyword\">ON</span> <span class=\"string\">`u`</span>.<span class=\"string\">`user_id`</span> = <span class=\"string\">`o`</span>.<span class=\"string\">`user_id`</span></div><div class=\"line\"><span class=\"keyword\">WHERE</span> (FROM_UNIXTIME(g.deadline, <span class=\"string\">'%Y%m%d%H%i'</span>) = <span class=\"number\">201811290010</span>)</div><div class=\"line\">  <span class=\"keyword\">AND</span> <span class=\"string\">`g`</span>.<span class=\"string\">`pay_number`</span> &gt; <span class=\"number\">0</span></div><div class=\"line\">  <span class=\"keyword\">AND</span> <span class=\"string\">`g`</span>.<span class=\"string\">`pay_total`</span> &gt; <span class=\"number\">1</span></div><div class=\"line\">  <span class=\"keyword\">AND</span> (g.pay_number &lt; g.pay_total)</div><div class=\"line\">  <span class=\"keyword\">AND</span> <span class=\"string\">`g`</span>.<span class=\"string\">`kind`</span> = <span class=\"number\">0</span></div><div class=\"line\">  <span class=\"keyword\">AND</span> <span class=\"string\">`g`</span>.<span class=\"string\">`promotion_type`</span> = <span class=\"number\">0</span></div></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># 以分钟为维度搜索</span></div><div class=\"line\">$currentMinute = date(<span class=\"string\">'YmdHi'</span>, time());</div><div class=\"line\">$order_list = DB::table(<span class=\"string\">'pin_group'</span>)-&gt;alias(<span class=\"string\">'g'</span>)</div><div class=\"line\">    -&gt;field(<span class=\"string\">'o.order_id,w.title,u.tg_user_id,o.express_mobile'</span>)</div><div class=\"line\">    -&gt;join(<span class=\"string\">'pin_ware w'</span>, <span class=\"string\">'w.ware_id=g.ware_id'</span>)</div><div class=\"line\">    -&gt;join(<span class=\"string\">'pin_order o'</span>, <span class=\"string\">'o.group_id=g.group_id'</span>)</div><div class=\"line\">    -&gt;join(<span class=\"string\">'pin_user u'</span>, <span class=\"string\">'u.user_id=o.user_id'</span>)</div><div class=\"line\">    -&gt;where(<span class=\"string\">\"FROM_UNIXTIME(g.deadline,'%Y%m%d%H%i') = $currentMinute\"</span>)</div><div class=\"line\">    -&gt;where(<span class=\"string\">'g.pay_number'</span>, <span class=\"string\">'&gt;'</span>, <span class=\"number\">0</span>)</div><div class=\"line\">    -&gt;where(<span class=\"string\">'g.pay_total'</span>, <span class=\"string\">'&gt;'</span>, <span class=\"number\">1</span>)</div><div class=\"line\">    -&gt;where(<span class=\"string\">'g.pay_number &lt; g.pay_total'</span>)</div><div class=\"line\">    -&gt;where(<span class=\"string\">'g.kind'</span>, <span class=\"number\">0</span>)</div><div class=\"line\">    -&gt;where(<span class=\"string\">'g.promotion_type'</span>, <span class=\"number\">0</span>)</div><div class=\"line\">    -&gt;select();</div></pre></td></tr></table></figure>\n<h3 id=\"A2：代码拆解\"><a href=\"#A2：代码拆解\" class=\"headerlink\" title=\"A2：代码拆解\"></a>A2：代码拆解</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">INDEX</span> idx_group_fail</div><div class=\"line\">  <span class=\"keyword\">ON</span> pin_group (deadline, pay_number, pay_total, kind, promotion_type);</div></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\">$current_minute_start = mktime(date(<span class=\"string\">\"H\"</span>), date(<span class=\"string\">\"i\"</span>), <span class=\"number\">0</span>);</div><div class=\"line\">$current_minute_end = mktime(date(<span class=\"string\">\"H\"</span>), date(<span class=\"string\">\"i\"</span>), <span class=\"number\">59</span>);</div><div class=\"line\">$order_list = DB::table(<span class=\"string\">'pin_group'</span>)-&gt;alias(<span class=\"string\">'g'</span>)</div><div class=\"line\">    -&gt;field(<span class=\"string\">'o.order_id,w.title,u.tg_user_id,o.express_mobile'</span>)</div><div class=\"line\">    -&gt;join(<span class=\"string\">'pin_ware w'</span>, <span class=\"string\">'w.ware_id=g.ware_id'</span>)</div><div class=\"line\">    -&gt;join(<span class=\"string\">'pin_order o'</span>, <span class=\"string\">'o.group_id=g.group_id'</span>)</div><div class=\"line\">    -&gt;join(<span class=\"string\">'pin_user u'</span>, <span class=\"string\">'u.user_id=o.user_id'</span>)</div><div class=\"line\">    -&gt;where(<span class=\"string\">'g.deadline'</span>, <span class=\"string\">'&gt;'</span>, $current_minute_start)</div><div class=\"line\">    -&gt;where(<span class=\"string\">'g.deadline'</span>, <span class=\"string\">'&lt;'</span>, $current_minute_end)</div><div class=\"line\">    -&gt;where(<span class=\"string\">'g.pay_number'</span>, <span class=\"string\">'&gt;'</span>, <span class=\"number\">0</span>)</div><div class=\"line\">    -&gt;where(<span class=\"string\">'g.pay_total'</span>, <span class=\"string\">'&gt;'</span>, <span class=\"number\">1</span>)</div><div class=\"line\">    -&gt;where(<span class=\"string\">'g.pay_number &lt; g.pay_total'</span>)</div><div class=\"line\">    -&gt;where(<span class=\"string\">'g.kind'</span>, <span class=\"number\">0</span>)</div><div class=\"line\">    -&gt;where(<span class=\"string\">'g.promotion_type'</span>, <span class=\"number\">0</span>)</div><div class=\"line\">    -&gt;select();</div></pre></td></tr></table></figure>\n<h2 id=\"Q3：\"><a href=\"#Q3：\" class=\"headerlink\" title=\"Q3：\"></a>Q3：</h2><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"keyword\">COUNT</span>(*) <span class=\"keyword\">AS</span> tp_count</div><div class=\"line\">  <span class=\"keyword\">FROM</span> (<span class=\"keyword\">SELECT</span> <span class=\"keyword\">count</span>(*)</div><div class=\"line\">        <span class=\"keyword\">FROM</span> <span class=\"string\">`profile_account`</span> <span class=\"string\">`pa`</span></div><div class=\"line\">               <span class=\"keyword\">LEFT</span> <span class=\"keyword\">JOIN</span> <span class=\"string\">`profile_access_log`</span> <span class=\"string\">`pal`</span> <span class=\"keyword\">ON</span> <span class=\"string\">`pa`</span>.<span class=\"string\">`id`</span> = <span class=\"string\">`pal`</span>.<span class=\"string\">`account_id`</span></div><div class=\"line\">        <span class=\"keyword\">GROUP</span> <span class=\"keyword\">BY</span> pa.id) <span class=\"string\">`_group_count_`</span></div><div class=\"line\">  <span class=\"keyword\">LIMIT</span> <span class=\"number\">1</span>;</div></pre></td></tr></table></figure>\n<h3 id=\"A3：LEFT-JOIN\"><a href=\"#A3：LEFT-JOIN\" class=\"headerlink\" title=\"A3：LEFT JOIN\"></a>A3：LEFT JOIN</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"keyword\">COUNT</span>(*) <span class=\"keyword\">AS</span> tp_count</div><div class=\"line\">  <span class=\"keyword\">FROM</span> (<span class=\"keyword\">SELECT</span> <span class=\"keyword\">count</span>(*)</div><div class=\"line\">        <span class=\"keyword\">FROM</span> <span class=\"string\">`profile_account`</span> <span class=\"string\">`pa`</span></div><div class=\"line\">        <span class=\"keyword\">GROUP</span> <span class=\"keyword\">BY</span> pa.id) <span class=\"string\">`_group_count_`</span></div><div class=\"line\">  <span class=\"keyword\">LIMIT</span> <span class=\"number\">1</span>;</div></pre></td></tr></table></figure>\n<h2 id=\"Q4：执行时长-3-秒；解析行数-491664；返回行数-16\"><a href=\"#Q4：执行时长-3-秒；解析行数-491664；返回行数-16\" class=\"headerlink\" title=\"Q4：执行时长 3 秒；解析行数 491664；返回行数 16\"></a>Q4：执行时长 3 秒；解析行数 491664；返回行数 16</h2><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"keyword\">COUNT</span>(*) <span class=\"keyword\">AS</span> tp_count</div><div class=\"line\">  <span class=\"keyword\">FROM</span> (<span class=\"keyword\">SELECT</span> <span class=\"keyword\">count</span>(*)</div><div class=\"line\">        <span class=\"keyword\">FROM</span> <span class=\"string\">`profile_account`</span> <span class=\"string\">`pa`</span></div><div class=\"line\">               <span class=\"keyword\">LEFT</span> <span class=\"keyword\">JOIN</span> <span class=\"string\">`profile_access_log`</span> <span class=\"string\">`pal`</span> <span class=\"keyword\">ON</span> <span class=\"string\">`pa`</span>.<span class=\"string\">`id`</span> = <span class=\"string\">`pal`</span>.<span class=\"string\">`account_id`</span></div><div class=\"line\">        <span class=\"keyword\">GROUP</span> <span class=\"keyword\">BY</span> pa.id) <span class=\"string\">`_group_count_`</span></div><div class=\"line\">  <span class=\"keyword\">LIMIT</span> <span class=\"number\">1</span>;</div></pre></td></tr></table></figure>\n<h3 id=\"A4：LEFT-JOIN\"><a href=\"#A4：LEFT-JOIN\" class=\"headerlink\" title=\"A4：LEFT JOIN\"></a>A4：LEFT JOIN</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"keyword\">COUNT</span>(*) <span class=\"keyword\">AS</span> tp_count</div><div class=\"line\">  <span class=\"keyword\">FROM</span> (<span class=\"keyword\">SELECT</span> <span class=\"keyword\">count</span>(*)</div><div class=\"line\">        <span class=\"keyword\">FROM</span> <span class=\"string\">`profile_account`</span> <span class=\"string\">`pa`</span></div><div class=\"line\">        <span class=\"keyword\">GROUP</span> <span class=\"keyword\">BY</span> pa.id) <span class=\"string\">`_group_count_`</span></div><div class=\"line\">  <span class=\"keyword\">LIMIT</span> <span class=\"number\">1</span>;</div></pre></td></tr></table></figure>\n"}