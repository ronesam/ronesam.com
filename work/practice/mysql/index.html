<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="chrome=1"><title>搜索引擎优化</title><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><meta name="author" content="ronesam"><meta name="description" content="慢速 SQL 的优化实践">
<meta property="og:type" content="article">
<meta property="og:title" content="搜索引擎优化">
<meta property="og:url" content="https://ronesam.com/work/practice/mysql/index.html">
<meta property="og:site_name" content="全栈开发之旅">
<meta property="og:description" content="慢速 SQL 的优化实践">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-12-13T08:03:48.501Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="搜索引擎优化">
<meta name="twitter:description" content="慢速 SQL 的优化实践"><link rel="icon" type="image/x-icon" href="/zero/img/favicon.ico"><link rel="stylesheet" href="/vendor/bootstrap/3.3.5/css/bootstrap.min.css"><link rel="stylesheet" href="/vendor/font-awesome/4.4.0/css/font-awesome.min.css"><link rel="stylesheet" href="/vendor/remodal/1.0.5/remodal.min.css"><link rel="stylesheet" href="/vendor/remodal/1.0.5/remodal-default-theme.min.css"><link rel="stylesheet" href="/vendor/gitment/0.0.3/default.css"><link rel="stylesheet" href="/zero/css/style.css"><script src="/vendor/jquery/2.1.4/jquery.min.js"></script></head><body><div class="wrapper"><header id="header"><div class="title"><h1><a href="/">全栈开发之旅</a></h1><p class="fa fa-angellist"><a href="/">学以致用, 刻意练习, 知行合一</a></p></div><nav class="nav"><ul><li><a href="/work/summary/">Work</a></li><li><a href="/think/summary/">Think</a></li><li><a href="/about/summary/">关于</a></li></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div class="content"><article class="post"><header><div class="icon"></div><a href="/work/practice/mysql/"><time datetime="2018-11-30T00:58:32.000Z">2018-11-30</time></a><h1 class="title">搜索引擎优化</h1></header><div class="entry"><blockquote><p>慢速 SQL 的优化实践</p>
</blockquote>
<a id="more"></a>
<h2 id="Q1：执行时长-2-秒；解析行数-535569；返回行数-0"><a href="#Q1：执行时长-2-秒；解析行数-535569；返回行数-0" class="headerlink" title="Q1：执行时长 2 秒；解析行数 535569；返回行数 0"></a>Q1：执行时长 2 秒；解析行数 535569；返回行数 0</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> *</div><div class="line"><span class="keyword">FROM</span> <span class="string">`pin_order`</span></div><div class="line"><span class="keyword">WHERE</span> <span class="string">`status`</span> = <span class="number">5</span></div><div class="line">  <span class="keyword">AND</span> <span class="string">`pay_kind`</span> &lt;&gt; <span class="number">2</span>;</div></pre></td></tr></table></figure>
<h3 id="A1：联合索引"><a href="#A1：联合索引" class="headerlink" title="A1：联合索引"></a>A1：联合索引</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> <span class="string">`idx_status_pay_kind`</span></div><div class="line">  <span class="keyword">ON</span> pin_order ( <span class="string">`status`</span> , <span class="string">`pay_kind`</span> );</div></pre></td></tr></table></figure>
<h2 id="Q2：执行时长-1-秒；解析行数-433707；返回行数-0"><a href="#Q2：执行时长-1-秒；解析行数-433707；返回行数-0" class="headerlink" title="Q2：执行时长 1 秒；解析行数 433707；返回行数 0"></a>Q2：执行时长 1 秒；解析行数 433707；返回行数 0</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="string">`o`</span>.<span class="string">`order_id`</span>, <span class="string">`w`</span>.<span class="string">`title`</span>, <span class="string">`u`</span>.<span class="string">`tg_user_id`</span>, <span class="string">`o`</span>.<span class="string">`express_mobile`</span></div><div class="line"><span class="keyword">FROM</span> <span class="string">`pin_group`</span> <span class="string">`g`</span></div><div class="line">       <span class="keyword">INNER</span> <span class="keyword">JOIN</span> <span class="string">`pin_ware`</span> <span class="string">`w`</span> <span class="keyword">ON</span> <span class="string">`w`</span>.<span class="string">`ware_id`</span> = <span class="string">`g`</span>.<span class="string">`ware_id`</span></div><div class="line">       <span class="keyword">INNER</span> <span class="keyword">JOIN</span> <span class="string">`pin_order`</span> <span class="string">`o`</span> <span class="keyword">ON</span> <span class="string">`o`</span>.<span class="string">`group_id`</span> = <span class="string">`g`</span>.<span class="string">`group_id`</span></div><div class="line">       <span class="keyword">INNER</span> <span class="keyword">JOIN</span> <span class="string">`pin_user`</span> <span class="string">`u`</span> <span class="keyword">ON</span> <span class="string">`u`</span>.<span class="string">`user_id`</span> = <span class="string">`o`</span>.<span class="string">`user_id`</span></div><div class="line"><span class="keyword">WHERE</span> (FROM_UNIXTIME(g.deadline, <span class="string">'%Y%m%d%H%i'</span>) = <span class="number">201811290010</span>)</div><div class="line">  <span class="keyword">AND</span> <span class="string">`g`</span>.<span class="string">`pay_number`</span> &gt; <span class="number">0</span></div><div class="line">  <span class="keyword">AND</span> <span class="string">`g`</span>.<span class="string">`pay_total`</span> &gt; <span class="number">1</span></div><div class="line">  <span class="keyword">AND</span> (g.pay_number &lt; g.pay_total)</div><div class="line">  <span class="keyword">AND</span> <span class="string">`g`</span>.<span class="string">`kind`</span> = <span class="number">0</span></div><div class="line">  <span class="keyword">AND</span> <span class="string">`g`</span>.<span class="string">`promotion_type`</span> = <span class="number">0</span></div></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 以分钟为维度搜索</span></div><div class="line">$currentMinute = date(<span class="string">'YmdHi'</span>, time());</div><div class="line">$order_list = DB::table(<span class="string">'pin_group'</span>)-&gt;alias(<span class="string">'g'</span>)</div><div class="line">    -&gt;field(<span class="string">'o.order_id,w.title,u.tg_user_id,o.express_mobile'</span>)</div><div class="line">    -&gt;join(<span class="string">'pin_ware w'</span>, <span class="string">'w.ware_id=g.ware_id'</span>)</div><div class="line">    -&gt;join(<span class="string">'pin_order o'</span>, <span class="string">'o.group_id=g.group_id'</span>)</div><div class="line">    -&gt;join(<span class="string">'pin_user u'</span>, <span class="string">'u.user_id=o.user_id'</span>)</div><div class="line">    -&gt;where(<span class="string">"FROM_UNIXTIME(g.deadline,'%Y%m%d%H%i') = $currentMinute"</span>)</div><div class="line">    -&gt;where(<span class="string">'g.pay_number'</span>, <span class="string">'&gt;'</span>, <span class="number">0</span>)</div><div class="line">    -&gt;where(<span class="string">'g.pay_total'</span>, <span class="string">'&gt;'</span>, <span class="number">1</span>)</div><div class="line">    -&gt;where(<span class="string">'g.pay_number &lt; g.pay_total'</span>)</div><div class="line">    -&gt;where(<span class="string">'g.kind'</span>, <span class="number">0</span>)</div><div class="line">    -&gt;where(<span class="string">'g.promotion_type'</span>, <span class="number">0</span>)</div><div class="line">    -&gt;select();</div></pre></td></tr></table></figure>
<h3 id="A2：代码拆解"><a href="#A2：代码拆解" class="headerlink" title="A2：代码拆解"></a>A2：代码拆解</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_group_fail</div><div class="line">  <span class="keyword">ON</span> pin_group (deadline, pay_number, pay_total, kind, promotion_type);</div></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$current_minute_start = mktime(date(<span class="string">"H"</span>), date(<span class="string">"i"</span>), <span class="number">0</span>);</div><div class="line">$current_minute_end = mktime(date(<span class="string">"H"</span>), date(<span class="string">"i"</span>), <span class="number">59</span>);</div><div class="line">$order_list = DB::table(<span class="string">'pin_group'</span>)-&gt;alias(<span class="string">'g'</span>)</div><div class="line">    -&gt;field(<span class="string">'o.order_id,w.title,u.tg_user_id,o.express_mobile'</span>)</div><div class="line">    -&gt;join(<span class="string">'pin_ware w'</span>, <span class="string">'w.ware_id=g.ware_id'</span>)</div><div class="line">    -&gt;join(<span class="string">'pin_order o'</span>, <span class="string">'o.group_id=g.group_id'</span>)</div><div class="line">    -&gt;join(<span class="string">'pin_user u'</span>, <span class="string">'u.user_id=o.user_id'</span>)</div><div class="line">    -&gt;where(<span class="string">'g.deadline'</span>, <span class="string">'&gt;'</span>, $current_minute_start)</div><div class="line">    -&gt;where(<span class="string">'g.deadline'</span>, <span class="string">'&lt;'</span>, $current_minute_end)</div><div class="line">    -&gt;where(<span class="string">'g.pay_number'</span>, <span class="string">'&gt;'</span>, <span class="number">0</span>)</div><div class="line">    -&gt;where(<span class="string">'g.pay_total'</span>, <span class="string">'&gt;'</span>, <span class="number">1</span>)</div><div class="line">    -&gt;where(<span class="string">'g.pay_number &lt; g.pay_total'</span>)</div><div class="line">    -&gt;where(<span class="string">'g.kind'</span>, <span class="number">0</span>)</div><div class="line">    -&gt;where(<span class="string">'g.promotion_type'</span>, <span class="number">0</span>)</div><div class="line">    -&gt;select();</div></pre></td></tr></table></figure>
<h2 id="Q3："><a href="#Q3：" class="headerlink" title="Q3："></a>Q3：</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> tp_count</div><div class="line">  <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="keyword">count</span>(*)</div><div class="line">        <span class="keyword">FROM</span> <span class="string">`profile_account`</span> <span class="string">`pa`</span></div><div class="line">               <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> <span class="string">`profile_access_log`</span> <span class="string">`pal`</span> <span class="keyword">ON</span> <span class="string">`pa`</span>.<span class="string">`id`</span> = <span class="string">`pal`</span>.<span class="string">`account_id`</span></div><div class="line">        <span class="keyword">GROUP</span> <span class="keyword">BY</span> pa.id) <span class="string">`_group_count_`</span></div><div class="line">  <span class="keyword">LIMIT</span> <span class="number">1</span>;</div></pre></td></tr></table></figure>
<h3 id="A3：LEFT-JOIN"><a href="#A3：LEFT-JOIN" class="headerlink" title="A3：LEFT JOIN"></a>A3：LEFT JOIN</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> tp_count</div><div class="line">  <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="keyword">count</span>(*)</div><div class="line">        <span class="keyword">FROM</span> <span class="string">`profile_account`</span> <span class="string">`pa`</span></div><div class="line">        <span class="keyword">GROUP</span> <span class="keyword">BY</span> pa.id) <span class="string">`_group_count_`</span></div><div class="line">  <span class="keyword">LIMIT</span> <span class="number">1</span>;</div></pre></td></tr></table></figure>
<h2 id="Q4：执行时长-3-秒；解析行数-491664；返回行数-16"><a href="#Q4：执行时长-3-秒；解析行数-491664；返回行数-16" class="headerlink" title="Q4：执行时长 3 秒；解析行数 491664；返回行数 16"></a>Q4：执行时长 3 秒；解析行数 491664；返回行数 16</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> tp_count</div><div class="line">  <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="keyword">count</span>(*)</div><div class="line">        <span class="keyword">FROM</span> <span class="string">`profile_account`</span> <span class="string">`pa`</span></div><div class="line">               <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> <span class="string">`profile_access_log`</span> <span class="string">`pal`</span> <span class="keyword">ON</span> <span class="string">`pa`</span>.<span class="string">`id`</span> = <span class="string">`pal`</span>.<span class="string">`account_id`</span></div><div class="line">        <span class="keyword">GROUP</span> <span class="keyword">BY</span> pa.id) <span class="string">`_group_count_`</span></div><div class="line">  <span class="keyword">LIMIT</span> <span class="number">1</span>;</div></pre></td></tr></table></figure>
<h3 id="A4：LEFT-JOIN"><a href="#A4：LEFT-JOIN" class="headerlink" title="A4：LEFT JOIN"></a>A4：LEFT JOIN</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> tp_count</div><div class="line">  <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="keyword">count</span>(*)</div><div class="line">        <span class="keyword">FROM</span> <span class="string">`profile_account`</span> <span class="string">`pa`</span></div><div class="line">        <span class="keyword">GROUP</span> <span class="keyword">BY</span> pa.id) <span class="string">`_group_count_`</span></div><div class="line">  <span class="keyword">LIMIT</span> <span class="number">1</span>;</div></pre></td></tr></table></figure>
</div><footer><div class="shares fa fa-github-alt"><a href="https://dev.tencent.com/u/ronesam" target="_blank">Hosted by Coding Pages</a></div></footer><div class="clearfix"></div></article><aside><ul class="action">   <li title="回到顶部" class="icon-arrow-up"> </li><li title="索引" data-remodal-target="toc" class="icon-toc"></li><li title="评论" data-remodal-target="comment" class="icon-comment"></li></ul><ul class="page"> <li class="icon-prev"></li><li title="目录" data-remodal-target="summary" class="icon-summary"></li><li class="icon-next"></li></ul></aside><div data-remodal-id="toc" data-remodal-options="hashTracking: false" class="remodal"><button data-remodal-action="close" class="remodal-close"></button><h3>索引</h3><article class="toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Q1：执行时长-2-秒；解析行数-535569；返回行数-0"><span class="toc-number">1.</span> <span class="toc-text">Q1：执行时长 2 秒；解析行数 535569；返回行数 0</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#A1：联合索引"><span class="toc-number">1.1.</span> <span class="toc-text">A1：联合索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Q2：执行时长-1-秒；解析行数-433707；返回行数-0"><span class="toc-number">2.</span> <span class="toc-text">Q2：执行时长 1 秒；解析行数 433707；返回行数 0</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#A2：代码拆解"><span class="toc-number">2.1.</span> <span class="toc-text">A2：代码拆解</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Q3："><span class="toc-number">3.</span> <span class="toc-text">Q3：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#A3：LEFT-JOIN"><span class="toc-number">3.1.</span> <span class="toc-text">A3：LEFT JOIN</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Q4：执行时长-3-秒；解析行数-491664；返回行数-16"><span class="toc-number">4.</span> <span class="toc-text">Q4：执行时长 3 秒；解析行数 491664；返回行数 16</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#A4：LEFT-JOIN"><span class="toc-number">4.1.</span> <span class="toc-text">A4：LEFT JOIN</span></a></li></ol></li></ol></article></div><div data-remodal-id="summary" data-remodal-options="hashTracking: false" class="remodal"><button data-remodal-action="close" class="remodal-close"></button><h3>目录</h3><article class="summary"></article></div><div data-remodal-id="comment" data-remodal-options="hashTracking: false" class="remodal"><button data-remodal-action="close" class="remodal-close"></button><h3>评论</h3><article id="comment"></article></div></div></div><footer id="footer"><div class="copyright"><span>&copy; 2015-2019</span><a href="https://dev.tencent.com/u/ronesam"> ronesam</a></div><div class="theme-copyright"><span>Theme by</span><a href="https://github.com/orderedlist/modernist" target="_blank"> orderedlist</a><span> | Redesign by</span><a href="https://dev.tencent.com/u/ronesam"> ronesam</a></div><div class="clearfix"></div></footer><script src="/vendor/remodal/1.0.5/remodal.min.js"></script><!-- 需要先载入全屏的函数，aside里面会重写，加入回调--><script src="/zero/js/aside.js"></script><!-- 载入评论--><script src="/vendor/gitment/0.0.3/gitment.browser.js"></script><script>var gitment = new Gitment({
  owner: 'ronesam',
  repo: 'ronesam.github.io',
  oauth: {
    client_id: 'd8d193947d058945daa3',
    client_secret: '58f7addd3ab01d3109d9d77e3bba651e0f8a9ba7',
  },
});
gitment.render('comment');</script></body></html>