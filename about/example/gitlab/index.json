{"summary":"<blockquote><p>任何软件开发，版本控制系统是必不可少的，这里选用<code>Gitlab-ce</code>社区一键安装版。</p>\n</blockquote>\n<a id=\"more\"></a>\n<p>系统配置：<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">Distribution      : CentOS 6.5 Minimal</div><div class=\"line\">GitLab version    : 8.14</div><div class=\"line\">Web<span class=\"built_in\"> Server </span>       : Nginx</div><div class=\"line\">Database          : PostgreSQL</div></pre></td></tr></table></figure></p>\n<p>启用清华大学的镜像：</p>\n<ul>\n<li>新建<code>/etc/yum.repos.d/gitlab-ce.repo</code>，内容为：</li>\n</ul>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"section\">[gitlab-ce]</span></div><div class=\"line\"><span class=\"attr\">name</span>=gitlab-ce</div><div class=\"line\"><span class=\"attr\">baseurl</span>=http://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el6</div><div class=\"line\"><span class=\"attr\">repo_gpgcheck</span>=<span class=\"number\">0</span></div><div class=\"line\"><span class=\"attr\">gpgcheck</span>=<span class=\"number\">0</span></div><div class=\"line\"><span class=\"attr\">enabled</span>=<span class=\"number\">1</span></div><div class=\"line\"><span class=\"attr\">gpgkey</span>=https://packages.gitlab.com/gpg.key</div></pre></td></tr></table></figure>\n<ul>\n<li>再执行：</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> yum makecache</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> yum install gitlab-ce</span></div></pre></td></tr></table></figure>\n<ul>\n<li>启动：</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> gitlab-ctl reconfigure</span></div></pre></td></tr></table></figure>\n<ul>\n<li>检查状态：</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># gitlab-ctl status</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"attr\">run:</span> <span class=\"attr\">gitlab-workhorse:</span> <span class=\"string\">(pid</span> <span class=\"number\">12604</span><span class=\"string\">)</span> <span class=\"number\">3495</span><span class=\"string\">s;</span> <span class=\"attr\">run:</span> <span class=\"attr\">log:</span> <span class=\"string\">(pid</span> <span class=\"number\">12414</span><span class=\"string\">)</span> <span class=\"number\">3525</span><span class=\"string\">s</span></div><div class=\"line\"><span class=\"attr\">run:</span> <span class=\"attr\">logrotate:</span> <span class=\"string\">(pid</span> <span class=\"number\">12486</span><span class=\"string\">)</span> <span class=\"number\">3508</span><span class=\"string\">s;</span> <span class=\"attr\">run:</span> <span class=\"attr\">log:</span> <span class=\"string\">(pid</span> <span class=\"number\">12485</span><span class=\"string\">)</span> <span class=\"number\">3508</span><span class=\"string\">s</span></div><div class=\"line\"><span class=\"attr\">down:</span> <span class=\"attr\">nginx:</span> <span class=\"number\">1</span><span class=\"string\">s,</span> <span class=\"string\">normally</span> <span class=\"string\">up,</span> <span class=\"string\">want</span> <span class=\"string\">up;</span> <span class=\"attr\">run:</span> <span class=\"attr\">log:</span> <span class=\"string\">(pid</span> <span class=\"number\">12425</span><span class=\"string\">)</span> <span class=\"number\">3524</span><span class=\"string\">s</span></div><div class=\"line\"><span class=\"attr\">run:</span> <span class=\"attr\">postgresql:</span> <span class=\"string\">(pid</span> <span class=\"number\">12272</span><span class=\"string\">)</span> <span class=\"number\">3560</span><span class=\"string\">s;</span> <span class=\"attr\">run:</span> <span class=\"attr\">log:</span> <span class=\"string\">(pid</span> <span class=\"number\">12271</span><span class=\"string\">)</span> <span class=\"number\">3560</span><span class=\"string\">s</span></div><div class=\"line\"><span class=\"attr\">run:</span> <span class=\"attr\">redis:</span> <span class=\"string\">(pid</span> <span class=\"number\">12189</span><span class=\"string\">)</span> <span class=\"number\">3566</span><span class=\"string\">s;</span> <span class=\"attr\">run:</span> <span class=\"attr\">log:</span> <span class=\"string\">(pid</span> <span class=\"number\">12188</span><span class=\"string\">)</span> <span class=\"number\">3566</span><span class=\"string\">s</span></div><div class=\"line\"><span class=\"attr\">run:</span> <span class=\"attr\">sidekiq:</span> <span class=\"string\">(pid</span> <span class=\"number\">12405</span><span class=\"string\">)</span> <span class=\"number\">3527</span><span class=\"string\">s;</span> <span class=\"attr\">run:</span> <span class=\"attr\">log:</span> <span class=\"string\">(pid</span> <span class=\"number\">12404</span><span class=\"string\">)</span> <span class=\"number\">3527</span><span class=\"string\">s</span></div><div class=\"line\"><span class=\"attr\">run:</span> <span class=\"attr\">unicorn:</span> <span class=\"string\">(pid</span> <span class=\"number\">12374</span><span class=\"string\">)</span> <span class=\"number\">3529</span><span class=\"string\">s;</span> <span class=\"attr\">run:</span> <span class=\"attr\">log:</span> <span class=\"string\">(pid</span> <span class=\"number\">12373</span><span class=\"string\">)</span> <span class=\"number\">3529</span><span class=\"string\">s</span></div></pre></td></tr></table></figure>\n<p>注意，此一键安装包的安装路径为：<code>/opt/gitlab/</code>。</p>\n<p>不仅如此，它也在<code>/opt/gitlab/embedded/</code>目录安装了一份自己依赖的<code>nginx</code>、<code>postgresql</code>、<code>redis</code>等等。</p>\n<p>上述<code>run</code>的内容其实就是它自带的软件。</p>\n<p>仔细看一下，<code>nginx</code>启动失败了。</p>\n<p>查看日志：<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># gitlab-ctl tail</span></div><div class=\"line\"></div><div class=\"line\">……</div><div class=\"line\">2016-11-24_12:12:29.04308 2016/11/24 20:12:29 [emerg] 16711#0: socket() [::]:80 failed (97:<span class=\"built_in\"> Address </span>family <span class=\"keyword\">not</span> supported by protocol)</div><div class=\"line\">……</div></pre></td></tr></table></figure></p>\n<p>不断滚动出现。</p>\n<p>各种百度，google，最后发现一句关键的话：</p>\n<blockquote>\n<p>So custombuild would skip to add the line if no Ipv6 exists? </p>\n</blockquote>\n<p>最后发现，阿里云默认是关闭<code>IPV6</code>，而<code>Nginx</code>默认监听了<code>IPV6</code>，由此发生了冲突。</p>\n<p>修改一下配置文件：<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> vim /etc/gitlab/gitlab.rb</span></div></pre></td></tr></table></figure></p>\n<p>关掉<code>IPV6</code>：</p>\n<blockquote>\n<p>nginx[‘listen_addresses’] = [‘*’, ‘[::]’]</p>\n</blockquote>\n<p>To：</p>\n<blockquote>\n<p>nginx[‘listen_addresses’] = [‘*’]</p>\n</blockquote>\n<p>修改访问域名：</p>\n<blockquote>\n<p>external_url ‘<a href=\"http://dajojojalfsdfjo8owrfol\" target=\"_blank\" rel=\"external\">http://dajojojalfsdfjo8owrfol</a>‘</p>\n</blockquote>\n<p>To：</p>\n<blockquote>\n<p>external_url ‘<a href=\"http://git.domain.com\" target=\"_blank\" rel=\"external\">http://git.domain.com</a>‘</p>\n</blockquote>\n<p>重新配置：<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> gitlab-ctl reconfigure</span></div></pre></td></tr></table></figure></p>\n<h2 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h2><ul>\n<li><a href=\"https://github.com/gitlabhq/gitlab-recipes/tree/master/install/centos\" target=\"_blank\" rel=\"external\">Gitlab官方安装文档（CentOS）</a></li>\n<li><a href=\"https://mirror.tuna.tsinghua.edu.cn/help/gitlab-ce/\" target=\"_blank\" rel=\"external\">Gitlab Community Edition 镜像使用帮助</a></li>\n<li><a href=\"https://docs.gitlab.com/omnibus/settings/nginx.html\" target=\"_blank\" rel=\"external\">NGINX settings</a></li>\n<li><a href=\"http://www.webhostingtalk.com/showthread.php?t=1350938\" target=\"_blank\" rel=\"external\">nginx: [emerg] socket() [::1]:80 failed (97: Address family not supported by protocol</a></li>\n<li><a href=\"https://docs.gitlab.com/omnibus/settings/smtp.html#qq-exmail\" target=\"_blank\" rel=\"external\">QQ exmail (腾讯企业邮箱)</a></li>\n</ul>\n"}