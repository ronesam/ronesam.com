<!DOCTYPE html><html><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="chrome=1"/><title>Gitlab: Node全栈开发之旅</title><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/><meta name="author" content="ronesam"/><meta name="description" content="任何软件开发，版本控制系统是必不可少的，这里选用Gitlab-ce社区一键安装版。">
<meta property="og:type" content="article">
<meta property="og:title" content="Gitlab">
<meta property="og:url" content="https://ronesam.com/about/example/gitlab/index.html">
<meta property="og:site_name" content="Node全栈开发之旅">
<meta property="og:description" content="任何软件开发，版本控制系统是必不可少的，这里选用Gitlab-ce社区一键安装版。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2017-12-27T08:44:21.983Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Gitlab">
<meta name="twitter:description" content="任何软件开发，版本控制系统是必不可少的，这里选用Gitlab-ce社区一键安装版。"><link rel="icon" type="image/x-icon" href="/zero/img/favicon.ico"/><link rel="stylesheet" href="/vendor/bootstrap/3.3.5/css/bootstrap.min.css"><link rel="stylesheet" href="/vendor/font-awesome/4.4.0/css/font-awesome.min.css"><link rel="stylesheet" href="/vendor/remodal/1.0.5/remodal.min.css"><link rel="stylesheet" href="/vendor/remodal/1.0.5/remodal-default-theme.min.css"><link rel="stylesheet" href="/zero/css/style.css"><script src="/vendor/jquery/2.1.4/jquery.min.js"></script></head><body><div class="wrapper"><header id="header"><div class="title"><h1><a href="/about/summary/">Node全栈开发之旅</a></h1><p class="fa fa-angellist"><a href="/about/summary/">学以致用, 刻意练习，知行合一</a></p></div><nav class="nav"><ul><li><a href="/wind/summary/">交互层</a></li><li><a href="/fire/summary/">业务层</a></li><li><a href="/water/summary/">服务层</a></li><li><a href="/earth/summary/">事务层</a></li></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div class="content"><article class="post"><header><div class="icon"></div><a href="/about/example/gitlab/"><time datetime="2017-12-27T08:44:21.982Z">2017-12-27</time></a><h1 class="title">Gitlab</h1></header><div class="entry"><blockquote><p>任何软件开发，版本控制系统是必不可少的，这里选用<code>Gitlab-ce</code>社区一键安装版。</p>
</blockquote>
<a id="more"></a>
<p>系统配置：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Distribution      : CentOS 6.5 Minimal</div><div class="line">GitLab version    : 8.14</div><div class="line">Web<span class="built_in"> Server </span>       : Nginx</div><div class="line">Database          : PostgreSQL</div></pre></td></tr></table></figure></p>
<p>启用清华大学的镜像：</p>
<ul>
<li>新建<code>/etc/yum.repos.d/gitlab-ce.repo</code>，内容为：</li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="section">[gitlab-ce]</span></div><div class="line"><span class="attr">name</span>=gitlab-ce</div><div class="line"><span class="attr">baseurl</span>=http://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el6</div><div class="line"><span class="attr">repo_gpgcheck</span>=<span class="number">0</span></div><div class="line"><span class="attr">gpgcheck</span>=<span class="number">0</span></div><div class="line"><span class="attr">enabled</span>=<span class="number">1</span></div><div class="line"><span class="attr">gpgkey</span>=https://packages.gitlab.com/gpg.key</div></pre></td></tr></table></figure>
<ul>
<li>再执行：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> yum makecache</span></div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> yum install gitlab-ce</span></div></pre></td></tr></table></figure>
<ul>
<li>启动：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> gitlab-ctl reconfigure</span></div></pre></td></tr></table></figure>
<ul>
<li>检查状态：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># gitlab-ctl status</span></div><div class="line"></div><div class="line"><span class="attr">run:</span> <span class="attr">gitlab-workhorse:</span> <span class="string">(pid</span> <span class="number">12604</span><span class="string">)</span> <span class="number">3495</span><span class="string">s;</span> <span class="attr">run:</span> <span class="attr">log:</span> <span class="string">(pid</span> <span class="number">12414</span><span class="string">)</span> <span class="number">3525</span><span class="string">s</span></div><div class="line"><span class="attr">run:</span> <span class="attr">logrotate:</span> <span class="string">(pid</span> <span class="number">12486</span><span class="string">)</span> <span class="number">3508</span><span class="string">s;</span> <span class="attr">run:</span> <span class="attr">log:</span> <span class="string">(pid</span> <span class="number">12485</span><span class="string">)</span> <span class="number">3508</span><span class="string">s</span></div><div class="line"><span class="attr">down:</span> <span class="attr">nginx:</span> <span class="number">1</span><span class="string">s,</span> <span class="string">normally</span> <span class="string">up,</span> <span class="string">want</span> <span class="string">up;</span> <span class="attr">run:</span> <span class="attr">log:</span> <span class="string">(pid</span> <span class="number">12425</span><span class="string">)</span> <span class="number">3524</span><span class="string">s</span></div><div class="line"><span class="attr">run:</span> <span class="attr">postgresql:</span> <span class="string">(pid</span> <span class="number">12272</span><span class="string">)</span> <span class="number">3560</span><span class="string">s;</span> <span class="attr">run:</span> <span class="attr">log:</span> <span class="string">(pid</span> <span class="number">12271</span><span class="string">)</span> <span class="number">3560</span><span class="string">s</span></div><div class="line"><span class="attr">run:</span> <span class="attr">redis:</span> <span class="string">(pid</span> <span class="number">12189</span><span class="string">)</span> <span class="number">3566</span><span class="string">s;</span> <span class="attr">run:</span> <span class="attr">log:</span> <span class="string">(pid</span> <span class="number">12188</span><span class="string">)</span> <span class="number">3566</span><span class="string">s</span></div><div class="line"><span class="attr">run:</span> <span class="attr">sidekiq:</span> <span class="string">(pid</span> <span class="number">12405</span><span class="string">)</span> <span class="number">3527</span><span class="string">s;</span> <span class="attr">run:</span> <span class="attr">log:</span> <span class="string">(pid</span> <span class="number">12404</span><span class="string">)</span> <span class="number">3527</span><span class="string">s</span></div><div class="line"><span class="attr">run:</span> <span class="attr">unicorn:</span> <span class="string">(pid</span> <span class="number">12374</span><span class="string">)</span> <span class="number">3529</span><span class="string">s;</span> <span class="attr">run:</span> <span class="attr">log:</span> <span class="string">(pid</span> <span class="number">12373</span><span class="string">)</span> <span class="number">3529</span><span class="string">s</span></div></pre></td></tr></table></figure>
<p>注意，此一键安装包的安装路径为：<code>/opt/gitlab/</code>。</p>
<p>不仅如此，它也在<code>/opt/gitlab/embedded/</code>目录安装了一份自己依赖的<code>nginx</code>、<code>postgresql</code>、<code>redis</code>等等。</p>
<p>上述<code>run</code>的内容其实就是它自带的软件。</p>
<p>仔细看一下，<code>nginx</code>启动失败了。</p>
<p>查看日志：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># gitlab-ctl tail</span></div><div class="line"></div><div class="line">……</div><div class="line">2016-11-24_12:12:29.04308 2016/11/24 20:12:29 [emerg] 16711#0: socket() [::]:80 failed (97:<span class="built_in"> Address </span>family <span class="keyword">not</span> supported by protocol)</div><div class="line">……</div></pre></td></tr></table></figure></p>
<p>不断滚动出现。</p>
<p>各种百度，google，最后发现一句关键的话：</p>
<blockquote>
<p>So custombuild would skip to add the line if no Ipv6 exists? </p>
</blockquote>
<p>最后发现，阿里云默认是关闭<code>IPV6</code>，而<code>Nginx</code>默认监听了<code>IPV6</code>，由此发生了冲突。</p>
<p>修改一下配置文件：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vim /etc/gitlab/gitlab.rb</span></div></pre></td></tr></table></figure></p>
<p>关掉<code>IPV6</code>：</p>
<blockquote>
<p>nginx[‘listen_addresses’] = [‘*’, ‘[::]’]</p>
</blockquote>
<p>To：</p>
<blockquote>
<p>nginx[‘listen_addresses’] = [‘*’]</p>
</blockquote>
<p>修改访问域名：</p>
<blockquote>
<p>external_url ‘<a href="http://dajojojalfsdfjo8owrfol" target="_blank" rel="external">http://dajojojalfsdfjo8owrfol</a>‘</p>
</blockquote>
<p>To：</p>
<blockquote>
<p>external_url ‘<a href="http://git.domain.com" target="_blank" rel="external">http://git.domain.com</a>‘</p>
</blockquote>
<p>重新配置：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> gitlab-ctl reconfigure</span></div></pre></td></tr></table></figure></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://github.com/gitlabhq/gitlab-recipes/tree/master/install/centos" target="_blank" rel="external">Gitlab官方安装文档（CentOS）</a></li>
<li><a href="https://mirror.tuna.tsinghua.edu.cn/help/gitlab-ce/" target="_blank" rel="external">Gitlab Community Edition 镜像使用帮助</a></li>
<li><a href="https://docs.gitlab.com/omnibus/settings/nginx.html" target="_blank" rel="external">NGINX settings</a></li>
<li><a href="http://www.webhostingtalk.com/showthread.php?t=1350938" target="_blank" rel="external">nginx: [emerg] socket() [::1]:80 failed (97: Address family not supported by protocol</a></li>
<li><a href="https://docs.gitlab.com/omnibus/settings/smtp.html#qq-exmail" target="_blank" rel="external">QQ exmail (腾讯企业邮箱)</a></li>
</ul>
</div><footer><div class="shares fa fa-github-alt"><a href="https://coding.net/u/ronesam" target="_blank">Hosted by Coding Pages</a></div></footer><div class="clearfix"></div></article><aside><ul class="action">   <li title="回到顶部" class="icon-arrow-up"> </li><li title="索引" data-remodal-target="toc" class="icon-toc"></li><li title="评论" data-remodal-target="comment" class="icon-comment"></li><li title="全屏" class="icon-fullscreen"></li></ul><ul class="page"> <li class="icon-prev"></li><li title="目录" data-remodal-target="summary" class="icon-summary"></li><li class="icon-next"></li></ul></aside><div data-remodal-id="toc" data-remodal-options="hashTracking: false" class="remodal"><button data-remodal-action="close" class="remodal-close"></button><h3>索引</h3><article class="toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">1.</span> <span class="toc-text">参考资料</span></a></li></ol></article></div><div data-remodal-id="summary" data-remodal-options="hashTracking: false" class="remodal"><button data-remodal-action="close" class="remodal-close"></button><h3>目录</h3><article class="summary"></article></div><div data-remodal-id="comment" data-remodal-options="hashTracking: false" class="remodal"><button data-remodal-action="close" class="remodal-close"></button><h3>评论</h3><article class="comment"><div data-thread-key="ronesam" data-title="Gitlab" data-url="/about/example/gitlab/" class="ds-thread"></div></article></div></div></div><footer id="footer"><div class="copyright">&copy; 2016 - 2018<a href="/about/summary/">ronesam</a></div><div class="theme-copyright">Theme by<a href="https://github.com/orderedlist/modernist" target="_blank">orderedlist</a>  | Redesign by <a href="/about/summary/">ronesam</a></div><div class="clearfix"></div></footer><script src="/vendor/remodal/1.0.5/remodal.min.js"></script><script src="/vendor/screenfull.js/2.0.0/screenfull.min.js"></script><!--需要先载入全屏的函数，aside里面会重写，加入回调--><script src="/zero/js/aside.js"></script><script>var duoshuoQuery = {short_name: 'ronesam'};</script></body></html>