<!DOCTYPE html><html><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="chrome=1"/><title>Elastic-Stack(原ELK): Node全栈开发之旅</title><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/><meta name="author" content="ronesam"/><meta name="description" content="不可错过的日志管理工具.">
<meta property="og:type" content="article">
<meta property="og:title" content="Elastic-Stack(原ELK)">
<meta property="og:url" content="https://ronesam.com/about/example/elastic-stack/index.html">
<meta property="og:site_name" content="Node全栈开发之旅">
<meta property="og:description" content="不可错过的日志管理工具.">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2017-12-27T08:44:21.982Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Elastic-Stack(原ELK)">
<meta name="twitter:description" content="不可错过的日志管理工具."><link rel="icon" type="image/x-icon" href="/zero/img/favicon.ico"/><link rel="stylesheet" href="/vendor/bootstrap/3.3.5/css/bootstrap.min.css"><link rel="stylesheet" href="/vendor/font-awesome/4.4.0/css/font-awesome.min.css"><link rel="stylesheet" href="/vendor/remodal/1.0.5/remodal.min.css"><link rel="stylesheet" href="/vendor/remodal/1.0.5/remodal-default-theme.min.css"><link rel="stylesheet" href="/zero/css/style.css"><script src="/vendor/jquery/2.1.4/jquery.min.js"></script></head><body><div class="wrapper"><header id="header"><div class="title"><h1><a href="/about/summary/">Node全栈开发之旅</a></h1><p class="fa fa-angellist"><a href="/about/summary/">学以致用, 刻意练习，知行合一</a></p></div><nav class="nav"><ul><li><a href="/wind/summary/">交互层</a></li><li><a href="/fire/summary/">业务层</a></li><li><a href="/water/summary/">服务层</a></li><li><a href="/earth/summary/">事务层</a></li></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div class="content"><article class="post"><header><div class="icon"></div><a href="/about/example/elastic-stack/"><time datetime="2017-12-27T08:44:21.982Z">2017-12-27</time></a><h1 class="title">Elastic-Stack(原ELK)</h1></header><div class="entry"><blockquote><p>不可错过的日志管理工具.</p>
</blockquote>
<a id="more"></a>
<h1 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h1><p>现有3台阿里云机器，系统版本为：CentOS 6.5、64位。</p>
<ul>
<li>web_47：admin</li>
<li>web_46：web1</li>
<li>web_140：web2</li>
</ul>
<p>其中<code>web_47</code>用于内部管理站点，外部用户不可访问；<code>web_46 &amp;&amp; web_140</code>同时对外提供web访问服务（Nginx负载均衡）。</p>
<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>需要把<code>web_47 &amp;&amp; web_46 &amp;&amp; web_140</code>上的系统日志：</p>
<ul>
<li>nginx-log</li>
<li>php-fpm-log</li>
<li>access-log</li>
</ul>
<p>以及<code>web_46 &amp;&amp; web_140</code>的用户访问日志：</p>
<ul>
<li>page-view-log</li>
</ul>
<p>统一转发到web_47，并通过pgv.xeon.ren来访问。</p>
<h1 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h1><p>以下是使用ELK(Elasticsearch &amp;&amp; Logstash &amp;&amp; Kibana)来搭建实时日志分析系统的过程：</p>
<h2 id="下载软件："><a href="#下载软件：" class="headerlink" title="下载软件："></a>下载软件：</h2><p>下载以下软件：</p>
<ul>
<li><a href="https://download.elastic.co/logstash/logstash/logstash-2.1.1.tar.gz" target="_blank" rel="external">logstash-2.1.1</a></li>
<li><a href="http://download.redis.io/releases/redis-2.8.4.tar.gz" target="_blank" rel="external">redis-2.8.4</a></li>
<li><a href="https://download.elasticsearch.org/elasticsearch/release/org/elasticsearch/distribution/tar/elasticsearch/2.1.0/elasticsearch-2.1.0.tar.gz" target="_blank" rel="external">elasticsearch-2.1.0</a></li>
<li><a href="https://download.elastic.co/kibana/kibana/kibana-4.3.1-linux-x64.tar.gz" target="_blank" rel="external">kibana-4.3.1-linux-x64</a></li>
</ul>
<p>上传到<code>web_47</code>，并解压到：<code>tar -zxvf *.tar.gz -C /usr/local/logger/</code></p>
<h2 id="启动Logstash"><a href="#启动Logstash" class="headerlink" title="启动Logstash"></a>启动Logstash</h2><p><em>Logstash</em>，日志收集器，通过它把散落在所有机器的所有日志收集起来。</p>
<p>这是个开箱即用的工具，并不需要安装，我们只需要配置好，并启用它即可。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/logger/logstash-2.1.1/bin/</span></div><div class="line"><span class="meta">#</span><span class="bash"> ./logstash -e <span class="string">""</span></span></div></pre></td></tr></table></figure>
<p>这一步的操作有点慢，耐心等待，直到提示出现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">……</div><div class="line">Logstash startup completed</div></pre></td></tr></table></figure>
<p>随便输入点什么，比如<code>Hello World!</code>：</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Hello World!</div><div class="line">&#123;</div><div class="line">       <span class="string">"message"</span> =&gt; <span class="string">"Hello World!"</span>,</div><div class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</div><div class="line">    <span class="string">"@timestamp"</span> =&gt; <span class="string">"2016-09-22T11:51:23.866Z"</span>,</div><div class="line">          <span class="string">"type"</span> =&gt; <span class="string">"stdin"</span>,</div><div class="line">          <span class="string">"host"</span> =&gt; <span class="string">"tugou07"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很好，测试成功了。</p>
<p>当然，这个并无实际意义，现在我们开始配置并收集PHP的错误日志：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/logger/logstash-2.1.1/</span></div><div class="line"><span class="meta">#</span><span class="bash"> mkdir conf</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> conf</span></div><div class="line"><span class="meta">#</span><span class="bash"> vim shipper.conf</span></div></pre></td></tr></table></figure>
<p>Logstash收集并处理过的原日志会自动删除吗？</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="http://www.w2bc.com/article/104935" target="_blank" rel="external">Logstash+Redis+Elasticsearch+Kibana+Nginx搭建日志分析系统</a></li>
<li><a href="http://kibana.logstash.es/content/" target="_blank" rel="external">ELKstack 中文指南</a></li>
<li><a href="http://www.cnblogs.com/xing901022/p/4802822.html" target="_blank" rel="external">Logstash使用详解</a></li>
<li><a href="http://www.jianshu.com/p/6575041b597d" target="_blank" rel="external">Logstash实践: 分布式系统的日志监控</a></li>
<li><a href="http://udn.yyuap.com/doc/logstash-best-practice-cn/index.html" target="_blank" rel="external">Logstash 最佳实践</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzIwMDc3Njk4NA==&amp;mid=2247483686&amp;idx=1&amp;sn=46bc77ff361cdce5bba59812e88b514f&amp;scene=0&amp;key=f5c31ae61525f82e97f5ef95160be90b6b79f39dc7604274da473bc782b6522906246423ce09c9ba7435d5ff05633270&amp;ascene=0&amp;uin=MTQ3NzAyNzQwMg%3D%3D&amp;devicety" target="_blank" rel="external">Elastic Stack V5详解</a></li>
</ul>
</div><footer><div class="shares fa fa-github-alt"><a href="https://coding.net/u/ronesam" target="_blank">Hosted by Coding Pages</a></div></footer><div class="clearfix"></div></article><aside><ul class="action">   <li title="回到顶部" class="icon-arrow-up"> </li><li title="索引" data-remodal-target="toc" class="icon-toc"></li><li title="评论" data-remodal-target="comment" class="icon-comment"></li><li title="全屏" class="icon-fullscreen"></li></ul><ul class="page"> <li class="icon-prev"></li><li title="目录" data-remodal-target="summary" class="icon-summary"></li><li class="icon-next"></li></ul></aside><div data-remodal-id="toc" data-remodal-options="hashTracking: false" class="remodal"><button data-remodal-action="close" class="remodal-close"></button><h3>索引</h3><article class="toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#场景"><span class="toc-number">1.</span> <span class="toc-text">场景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#需求"><span class="toc-number">2.</span> <span class="toc-text">需求</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#过程"><span class="toc-number">3.</span> <span class="toc-text">过程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#下载软件："><span class="toc-number">3.1.</span> <span class="toc-text">下载软件：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#启动Logstash"><span class="toc-number">3.2.</span> <span class="toc-text">启动Logstash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">3.3.</span> <span class="toc-text">参考资料</span></a></li></ol></li></ol></article></div><div data-remodal-id="summary" data-remodal-options="hashTracking: false" class="remodal"><button data-remodal-action="close" class="remodal-close"></button><h3>目录</h3><article class="summary"></article></div><div data-remodal-id="comment" data-remodal-options="hashTracking: false" class="remodal"><button data-remodal-action="close" class="remodal-close"></button><h3>评论</h3><article class="comment"><div data-thread-key="ronesam" data-title="Elastic-Stack(原ELK)" data-url="/about/example/elastic-stack/" class="ds-thread"></div></article></div></div></div><footer id="footer"><div class="copyright">&copy; 2016 - 2018<a href="/about/summary/">ronesam</a></div><div class="theme-copyright">Theme by<a href="https://github.com/orderedlist/modernist" target="_blank">orderedlist</a>  | Redesign by <a href="/about/summary/">ronesam</a></div><div class="clearfix"></div></footer><script src="/vendor/remodal/1.0.5/remodal.min.js"></script><script src="/vendor/screenfull.js/2.0.0/screenfull.min.js"></script><!--需要先载入全屏的函数，aside里面会重写，加入回调--><script src="/zero/js/aside.js"></script><script>var duoshuoQuery = {short_name: 'ronesam'};</script></body></html>