{"summary":"<blockquote><p>确保系统高效稳定运行, 好的架构能让事半功倍.</p>\n</blockquote>\n<a id=\"more\"></a>\n<h2 id=\"四层架构\"><a href=\"#四层架构\" class=\"headerlink\" title=\"四层架构\"></a>四层架构</h2><p><img src=\"filehelper_1484201308480_7.png\" alt=\"四层架构\"></p>\n<h2 id=\"理解MVC\"><a href=\"#理解MVC\" class=\"headerlink\" title=\"理解MVC\"></a>理解MVC</h2><ul>\n<li>一个<strong>系统执行者</strong>（<code>Actor</code>）可以执行多个<strong>系统用例</strong>（<code>Case</code>）<ul>\n<li>但不能多个<code>Actor</code>执行同一个<code>Case</code></li>\n<li>通常情况可以认为<code>Case</code>就是<code>Page</code></li>\n</ul>\n</li>\n<li>一个<code>Case</code>对应一个<strong>视图控制器</strong>（<code>ViewController</code>）<ul>\n<li>也就是<code>MVC</code>中的<code>Controller</code>，其实属于四层架构中<strong>交互层</strong>的一部分</li>\n<li>使用<code>index</code>方法提供基本<code>View</code><ul>\n<li>不是说那些个<code>HTML</code>文件就是<code>View</code>，它们仅仅是模板</li>\n<li>经过浏览器解析渲染呈现出来的，<code>Actor</code>可视的部分才是<code>View</code></li>\n<li>模板原本由<code>Smarty</code>等模板引擎控制，语法复杂，难以协作</li>\n<li>正逐渐被<code>Vue</code>，<code>React</code>，<code>Angular</code>等前端框架替代，推荐<code>Vue</code></li>\n</ul>\n</li>\n<li>完成<code>Case</code>需要多个操作步骤（<code>Action</code>）<ul>\n<li>注意：此时<code>URI</code>不变</li>\n<li><code>Action</code>仅获取和过滤参数（防止<code>XSS</code>、<code>CSRF</code>、<code>SQL</code>注入等）<ul>\n<li>原则上不对参数进行逻辑校验</li>\n<li>除非因不同参数需要跳转不同<code>Controller</code></li>\n<li>除非因不同参数需要调用不同<code>Logic</code></li>\n<li>除非因不同参数可跳过不处理<code>Logic</code> </li>\n</ul>\n</li>\n<li>参数透传给跨域的<code>Service</code>或者本域的<code>Logic</code>处理</li>\n<li>判断处理结果，异常则中断过程直接返回；否则继续调用下一个<code>Service</code>或者<code>Logic</code></li>\n</ul>\n</li>\n<li>返回<code>HTML</code>、<code>Json</code>或者直接跳转（<code>Redirect</code>）</li>\n</ul>\n</li>\n<li>一个<code>Controller</code>也许会调用多个<code>AppController</code><ul>\n<li>也就是<code>TP</code>框架中的<code>Service</code>，对应四层架构中<strong>应用逻辑</strong>或者<strong>服务层</strong></li>\n<li>与<code>Controller</code>基本类似，但仅供内部跨域调用，用户不能直接访问</li>\n<li>使用内部<code>HTTP</code>调用，防止服务中断后页面直接报错</li>\n<li>不可以调用其它<code>Service</code>，以防死循环</li>\n</ul>\n</li>\n<li>一个<code>Service</code>可能会涉及到不同的领域逻辑（<code>Logic</code>）<ul>\n<li>对应四层架构中<strong>领域逻辑</strong>或者<strong>业务层</strong></li>\n<li>就近原则：谁使用参数，谁负责校验</li>\n<li>不可拆分的最小业务单元</li>\n<li><code>Logic</code>之间禁止相互调用，也不可以被跨域调用</li>\n</ul>\n</li>\n<li>一个<code>Logic</code>可能会调用不同的来源的数据模型（<code>Model</code>）<ul>\n<li>对应四层架构中<strong>数据模型</strong>或者<strong>事务层</strong></li>\n<li>领域模型 = 领域逻辑（<code>Logic</code>） + 数据模型（<code>Model</code>）</li>\n<li>重点是实体以及实体之间的联系，也就是<strong>ER图</strong></li>\n<li>负责实现状态机以及状态码的中文解释等</li>\n</ul>\n</li>\n<li>通俗来说，以餐馆为例<ul>\n<li>店小二是<code>Controller</code>，负责将顾客点菜，并将菜单发给厨师，把菜端给客户；<ul>\n<li>厨师是<code>Logic</code>，只有他才知道原料是否有货，才能把菜做好给小二；小二不能直接拿到原料就对顾客说，只有这些东西，你自己做来吃吧；顾客要的始终是菜；</li>\n<li>后勤是<code>Model</code>，负责原料的采购；</li>\n<li>假设这个餐馆是肯德基或者麦当劳，那么就需要一个中央厨房，将菜品标准化，这个中央厨房就是<code>Service</code></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"目录规划\"><a href=\"#目录规划\" class=\"headerlink\" title=\"目录规划\"></a>目录规划</h2><ul>\n<li><strong>站点目录</strong>是指存放网站所有相关文件的目录</li>\n<li><strong>站点根目录</strong>是指用户通过域名能够访问到的部分，通常是站点目录的子目录<ul>\n<li>如果是IIS服务器，一般为：<code>wwwroot</code></li>\n<li>如果是<code>Apache</code>服务器，一般为：<code>htdocs</code></li>\n<li>而在<code>ThinkPHP</code>框架中，一般为：<code>public</code></li>\n<li><code>Home</code>原本是指站点首页，对应的是<strong>根目录</strong>下的<code>index</code>文件<ul>\n<li><code>index</code>文件有很多，可能每个目录下面都有一个，但只有<strong>根目录</strong>下的这个才被称为<code>Home</code></li>\n<li>但在框架中，<code>index.php</code>已经变成前端控制器</li>\n<li>所以只能引入<code>Home</code>模块作为默认模块</li>\n<li>每个模块都有一个默认的方法<code>index</code>，提供默认<code>View</code></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><code>Application</code>：按照产品来划分目录<ul>\n<li>通用产品<ul>\n<li><code>base</code>：放置所有基类<ul>\n<li><code>controller</code>：按照域名前缀划分子目录</li>\n<li>没有任何业务逻辑和服务</li>\n<li><code>view</code>：同样按照域名前缀来划分，但不要直接修改，请参考<strong>前端工程</strong>里的说明</li>\n<li><code>view/common</code>：存放全站公共的基础函数</li>\n</ul>\n</li>\n<li><code>home</code>：首页<ul>\n<li>包括通用的业务逻辑和服务</li>\n</ul>\n</li>\n<li><code>profile</code>：用户中心</li>\n<li><code>business</code>：商户中心</li>\n</ul>\n</li>\n<li>配置文件<ul>\n<li><code>.env</code>：<strong>站点目录</strong>下的隐藏文件，配置不同开发环境的数据库连接参数等</li>\n<li><code>route_service.php</code>：提供内部<code>Service</code>调用</li>\n<li><code>common.php</code>：尽量不要使用，所有助手函数分类放到<code>Helper</code>里面去</li>\n<li><code>Result.php</code>：<code>Logic</code>和<code>Service</code>的统一返回值</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div></pre></td><td class=\"code\"><pre><div class=\"line\">.</div><div class=\"line\">├── base</div><div class=\"line\">│   ├── controller</div><div class=\"line\">│   │   ├── api</div><div class=\"line\">│   │   ├── m</div><div class=\"line\">│   │   ├── www</div><div class=\"line\">│   │   └── xdb</div><div class=\"line\">│   ├── logic</div><div class=\"line\">│   │   ├── BaseLogic.php</div><div class=\"line\">│   │   └── Result.php</div><div class=\"line\">│   ├── model</div><div class=\"line\">│   │   └── BaseModel.php</div><div class=\"line\">│   ├── service</div><div class=\"line\">│   │   ├── BaseService.php</div><div class=\"line\">│   │   └── ServiceResult.php</div><div class=\"line\">│   └── view</div><div class=\"line\">│       └── xdb</div><div class=\"line\">├── business</div><div class=\"line\">│   ├── config.php</div><div class=\"line\">│   ├── controller</div><div class=\"line\">│   ├── logic</div><div class=\"line\">│   ├── model</div><div class=\"line\">│   ├── service</div><div class=\"line\">│   └── view</div><div class=\"line\">├── command.php</div><div class=\"line\">├── common.php</div><div class=\"line\">├── config.php</div><div class=\"line\">├── database.php</div><div class=\"line\">├── home</div><div class=\"line\">│   ├── controller</div><div class=\"line\">│   ├── logic</div><div class=\"line\">│   ├── model</div><div class=\"line\">│   ├── service</div><div class=\"line\">│   └── view</div><div class=\"line\">├── profile</div><div class=\"line\">│   ├── controller</div><div class=\"line\">│   ├── logic</div><div class=\"line\">│   ├── model</div><div class=\"line\">│   └── service</div><div class=\"line\">├── route_service.php</div><div class=\"line\">├── yan</div><div class=\"line\">│   ├── config.php</div><div class=\"line\">│   ├── controller</div><div class=\"line\">│   ├── database.php</div><div class=\"line\">│   ├── logic</div><div class=\"line\">│   ├── model</div><div class=\"line\">│   └── view</div><div class=\"line\">└── zhuan</div></pre></td></tr></table></figure>\n<h2 id=\"前端工程\"><a href=\"#前端工程\" class=\"headerlink\" title=\"前端工程\"></a>前端工程</h2><h3 id=\"访问目录：\"><a href=\"#访问目录：\" class=\"headerlink\" title=\"访问目录：\"></a>访问目录：</h3><blockquote>\n<p>部署在<code>/data/htdocs/**</code></p>\n</blockquote>\n<ul>\n<li>CDN：<code>static.tugou.com</code></li>\n<li>内网： <code>/public/static</code></li>\n</ul>\n<h3 id=\"源码目录：\"><a href=\"#源码目录：\" class=\"headerlink\" title=\"源码目录：\"></a>源码目录：</h3><blockquote>\n<p>部署在<code>**/view/[site]</code></p>\n</blockquote>\n<ul>\n<li>工程目录：<code>@asset</code><ul>\n<li>此目录下所有文件最终生成到同级目录下的<code>@static</code></li>\n<li><code>.css</code>文件统一建议一个scss目录存放</li>\n</ul>\n</li>\n<li>发布目录：<code>@static</code><ul>\n<li>此目录下的所有文件必须上传<code>SVN</code>，并发布到对应的访问目录</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"编译发布：\"><a href=\"#编译发布：\" class=\"headerlink\" title=\"编译发布：\"></a>编译发布：</h3><ul>\n<li>安装最新<code>LTS</code>版本的<code>NodeJs</code>和<code>NPM</code></li>\n<li>进入站点目录执行：<code>npm install</code></li>\n<li>启动文件监听：<code>npm start</code></li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">\"name\"</span>: <span class=\"string\">\"tugou-static\"</span>,</div><div class=\"line\">  <span class=\"attr\">\"version\"</span>: <span class=\"string\">\"1.0.2\"</span>,</div><div class=\"line\">  <span class=\"attr\">\"description\"</span>: <span class=\"string\">\"this is tugou enterprise project\"</span>,</div><div class=\"line\">  <span class=\"attr\">\"main\"</span>: <span class=\"string\">\"package.json\"</span>,</div><div class=\"line\">  <span class=\"attr\">\"dependencies\"</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">\"gulp\"</span>: <span class=\"string\">\"3.9.1\"</span>,</div><div class=\"line\">    <span class=\"attr\">\"gulp-autoprefixer\"</span>: <span class=\"string\">\"^3.1.1\"</span>,</div><div class=\"line\">    <span class=\"attr\">\"gulp-clean-css\"</span>: <span class=\"string\">\"^2.3.2\"</span>,</div><div class=\"line\">    <span class=\"attr\">\"gulp-debug\"</span>: <span class=\"string\">\"^3.1.0\"</span>,</div><div class=\"line\">    <span class=\"attr\">\"gulp-rem\"</span>: <span class=\"string\">\"^1.1.6\"</span>,</div><div class=\"line\">    <span class=\"attr\">\"gulp-ruby-sass\"</span>: <span class=\"string\">\"^2.1.1\"</span>,</div><div class=\"line\">    <span class=\"attr\">\"gulp-sftp\"</span>: <span class=\"string\">\"^0.1.5\"</span></div><div class=\"line\">  &#125;,</div><div class=\"line\">  <span class=\"attr\">\"devDependencies\"</span>: &#123;&#125;,</div><div class=\"line\">  <span class=\"attr\">\"scripts\"</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">\"start\"</span>: <span class=\"string\">\"gulp\"</span></div><div class=\"line\">  &#125;,</div><div class=\"line\">  <span class=\"attr\">\"author\"</span>: <span class=\"string\">\"ronesam\"</span>,</div><div class=\"line\">  <span class=\"attr\">\"private\"</span>: <span class=\"string\">\"true\"</span>,</div><div class=\"line\">  <span class=\"attr\">\"license\"</span>: <span class=\"string\">\"ISC\"</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"第三方：\"><a href=\"#第三方：\" class=\"headerlink\" title=\"第三方：\"></a>第三方：</h3><blockquote>\n<p>部署在<code>/vendor</code></p>\n</blockquote>\n<ul>\n<li>使用<code>Bower</code>下载模块到<code>@asset</code></li>\n<li>拷贝<code>@asset/module/dist</code>目录内的文件到<code>@static/moudule-v1</code></li>\n<li>发布到<code>static.tugou.com/vendor</code></li>\n</ul>\n<figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\"># bower.json</span></div><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"string\">\"name\"</span>: <span class=\"string\">\"tugou-static-vendor\"</span>,</div><div class=\"line\">  <span class=\"string\">\"description\"</span>: <span class=\"string\">\"兔狗第三方库\"</span>,</div><div class=\"line\">  <span class=\"string\">\"main\"</span>: <span class=\"string\">\"package.json\"</span>,</div><div class=\"line\">  <span class=\"string\">\"authors\"</span>: [</div><div class=\"line\">    <span class=\"string\">\"ronesam\"</span></div><div class=\"line\">  ],</div><div class=\"line\">  <span class=\"string\">\"license\"</span>: <span class=\"string\">\"MIT\"</span>,</div><div class=\"line\">  <span class=\"string\">\"homepage\"</span>: <span class=\"string\">\"\"</span>,</div><div class=\"line\">  <span class=\"string\">\"private\"</span>: <span class=\"literal\">true</span>,</div><div class=\"line\">  <span class=\"string\">\"ignore\"</span>: [</div><div class=\"line\">    <span class=\"string\">\"**/.*\"</span>,</div><div class=\"line\">    <span class=\"string\">\"node_modules\"</span>,</div><div class=\"line\">    <span class=\"string\">\"bower_components\"</span>,</div><div class=\"line\">    <span class=\"string\">\"test\"</span>,</div><div class=\"line\">    <span class=\"string\">\"tests\"</span></div><div class=\"line\">  ],</div><div class=\"line\">  <span class=\"string\">\"dependencies\"</span>: &#123;</div><div class=\"line\">    <span class=\"string\">\"blueimp-md5-v2\"</span>: <span class=\"string\">\"blueimp-md5#^2.7.0\"</span>,</div><div class=\"line\">    <span class=\"string\">\"bootstrap-v3\"</span>: <span class=\"string\">\"bootstrap#^3.3.7\"</span>,</div><div class=\"line\">    <span class=\"string\">\"clipboard-v1\"</span>: <span class=\"string\">\"clipboard#^1.6.1\"</span>,</div><div class=\"line\">    <span class=\"string\">\"devbridge-autocomplete-v1\"</span>: <span class=\"string\">\"devbridge-autocomplete#^1.3.0\"</span>,</div><div class=\"line\">    <span class=\"string\">\"element-ui-v1\"</span>: <span class=\"string\">\"element-ui#^1.2.4\"</span>,</div><div class=\"line\">    <span class=\"string\">\"es6-promise-v4\"</span>: <span class=\"string\">\"es6-promise#^4.0.5\"</span>,</div><div class=\"line\">    <span class=\"string\">\"flatpickr-v2\"</span>: <span class=\"string\">\"flatpickr-calendar#^2.4.4\"</span>,</div><div class=\"line\">    <span class=\"string\">\"font-awesome-v4\"</span>: <span class=\"string\">\"font-awesome#^4.7.0\"</span>,</div><div class=\"line\">    <span class=\"string\">\"jBox-v0\"</span>: <span class=\"string\">\"jbox#^0.4.7\"</span>,</div><div class=\"line\">    <span class=\"string\">\"jquery-cookie-v1\"</span>: <span class=\"string\">\"jquery-cookie#^1.4.1\"</span>,</div><div class=\"line\">    <span class=\"string\">\"jquery-dateFormat-v1\"</span>: <span class=\"string\">\"jquery-dateFormat#^1.0.0\"</span>,</div><div class=\"line\">    <span class=\"string\">\"jquery-nicescroll-v3\"</span>: <span class=\"string\">\"jquery-nicescroll#^3.6.8\"</span>,</div><div class=\"line\">    <span class=\"string\">\"jquery-powertip-v1\"</span>: <span class=\"string\">\"jquery-powertip#^1.3.0\"</span>,</div><div class=\"line\">    <span class=\"string\">\"jquery-v1\"</span>: <span class=\"string\">\"jquery#^1.12.4\"</span>,</div><div class=\"line\">    <span class=\"string\">\"jquery-v2\"</span>: <span class=\"string\">\"jquery#^2.2.4\"</span>,</div><div class=\"line\">    <span class=\"string\">\"jquery-v3\"</span>: <span class=\"string\">\"jquery#^3.1.1\"</span>,</div><div class=\"line\">    <span class=\"string\">\"js-cookie-v2\"</span>: <span class=\"string\">\"js-cookie#^2.1.3\"</span>,</div><div class=\"line\">    <span class=\"string\">\"lodash-v4\"</span>: <span class=\"string\">\"lodash#^4.17.4\"</span>,</div><div class=\"line\">    <span class=\"string\">\"moment-v2\"</span>: <span class=\"string\">\"moment#^2.17.1\"</span>,</div><div class=\"line\">    <span class=\"string\">\"swiper-v3\"</span>: <span class=\"string\">\"swiper#^3.4.1\"</span>,</div><div class=\"line\">    <span class=\"string\">\"velocity-v1\"</span>: <span class=\"string\">\"velocity#^1.4.3\"</span>,</div><div class=\"line\">    <span class=\"string\">\"vue-resource-v1\"</span>: <span class=\"string\">\"vue-resource#^1.2.1\"</span>,</div><div class=\"line\">    <span class=\"string\">\"vue-v1\"</span>: <span class=\"string\">\"vue#^1.0.28\"</span>,</div><div class=\"line\">    <span class=\"string\">\"vue-v2\"</span>: <span class=\"string\">\"vue#^2.2.2\"</span>,</div><div class=\"line\">    <span class=\"string\">\"vue-validator-v2\"</span>: <span class=\"string\">\"vue-validator#^2.1.6\"</span></div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>"}